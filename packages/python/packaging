#!/bin/bash

set -e
set -u

# We grab the latest versions that are in the directory
#PYTHON_VERSION=`ls -r python/Python-*.tar.xz | sed 's/python\/Python-\(.*\)\.tar\.xz/\1/' | head -1`
PYTHON_VERSION="3.9.7"


sudo apt install libreadline-gplv2-dev libncursesw5-dev libssl-dev \
	    libsqlite3-dev tk-dev libgdbm-dev libc6-dev libbz2-dev libffi-dev zlib1g-dev -y

echo "Extracting libffi-3.2.tar.gz ..."
if ! tar xpvf python/libffi-3.2.tar.gz ; then
  echo "Failed extracting libffi-3.2.tar.gz ..."
  exit 1
fi

echo "Installing libffi..."
pushd libffi-3.2
  ./configure --prefix="${BOSH_INSTALL_TARGET}"/libffi
  make
  make install
popd

export LDFLAGS=-L${BOSH_INSTALL_TARGET}/libffi/lib
export PKG_CONFIG_PATH=${BOSH_INSTALL_TARGET}/libffi/lib/pkgconfig

# Extract python package
echo "Extracting python ${PYTHON_VERSION}..."
tar xpvf ${BOSH_COMPILE_TARGET}/python/Python-${PYTHON_VERSION}.tar.xz
if [[ $? != 0 ]] ; then
  echo "Failed extracting python ${PYTHON_VERSION}"
  exit 1
fi

# Copy python package
echo "Copying python ${PYTHON_VERSION}..."
cp -a ${BOSH_COMPILE_TARGET}/Python-${PYTHON_VERSION}/* ${BOSH_INSTALL_TARGET}/

echo "Installing python..."
cd ${BOSH_INSTALL_TARGET}
./configure --prefix=$BOSH_INSTALL_TARGET
make
make install

cp /var/vcap/packages/python/bin/pip3 /usr/local/bin/pip3
